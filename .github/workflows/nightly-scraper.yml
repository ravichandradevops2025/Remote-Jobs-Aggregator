name: Nightly Job Scraper & Export

on:
  push:        # runs on every push
    branches:
      - main   # or master if that's your default branch
  workflow_dispatch:   # manual trigger
  schedule:
    - cron: '30 19 * * *'  # 01:00 AM IST daily

jobs:
  scrape-and-export:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Run job scraper and export
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
      run: |
        echo "ðŸš€ Starting job scraper and export..."
        python scripts/export_jobs.py
    
    - name: Create job summary report
      run: |
        echo "ðŸ“Š Creating summary report..."
        python scripts/create_summary.py
    
    - name: Generate timestamp for artifacts
      id: timestamp
      run: echo "timestamp=$(date +'%Y-%m-%d_%H-%M-%S')" >> $GITHUB_OUTPUT
    
    - name: Upload job data as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: remote-jobs-${{ steps.timestamp.outputs.timestamp }}
        path: |
          scraped_jobs.json
          job_browser.html
          jobs_summary.txt
        retention-days: 30
    
    - name: Display job summary in workflow
      run: |
        echo "## ðŸ“‹ Job Scraping Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        cat jobs_summary.txt >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ **Download the complete job data from the Artifacts section below**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Files Generated:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“„ \`scraped_jobs.json\` - All jobs in JSON format" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ \`job_browser.html\` - Interactive web browser for jobs" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“Š \`jobs_summary.txt\` - Quick statistics and overview" >> $GITHUB_STEP_SUMMARY